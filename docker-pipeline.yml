pool:
  name: Hosted Ubuntu 1604
steps:

- bash: |
    shopt -s nullglob
    function join_by { local IFS="$1"; shift; echo "$*"; }
    lib_path=$(join_by ';' $(Agent.WorkFolder)/_tasks/GitVersion*/4.0.*/lib/linux/x86_64)
    echo LD_LIBRARY_PATH: $lib_path
    echo "##vso[task.setvariable variable=LD_LIBRARY_PATH]$lib_path"
  displayName: Update LD_LIBRARY_PATH for GitVersion

- task: GitVersion@4
  displayName: 'GitVersion'
  inputs:
    updateAssemblyInfo: true

- task: GitHubRelease@0
  inputs:
    gitHubConnection: 'GitHub'
    action: 'create'
    tagSource: 'manual'
    tag: 'v$(GitVersion.SemVer)'
    title: 'v$(GitVersion.SemVer)'
    isPreRelease: contains(variables['GitVersion.SemVer'], '-')
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))

- task: Docker@0
  displayName: 'Build Synker Api image'
  inputs:
    containerregistrytype: 'Container Registry'
    dockerRegistryConnection: docker
    defaultContext: false
    context: '$(Build.SourcesDirectory)'
    imageName: 'synker/synker_api:$(GitVersion.SemVer)'
    includeLatestTag: true

- task: Docker@0
  displayName: 'Push Synker image'
  inputs:
    containerregistrytype: 'Container Registry'
    dockerRegistryConnection: docker
    action: 'Push an image'
    imageName: 'synker/synker_api:$(GitVersion.SemVer)'
    includeLatestTag: true